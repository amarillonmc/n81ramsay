# 系统修复记录

## 目录

1. [路由处理修复](#路由处理修复)
2. [环境配置修复](#环境配置修复)
3. [部署配置修复](#部署配置修复)
4. [调试功能修复](#调试功能修复)
5. [PHP兼容性修复](#PHP兼容性修复)

## 路由处理修复

### 问题描述
界面上的大部分链接点击后出现HTTP 404错误。

### 修复内容
- 修改了入口文件中的路由处理逻辑，增加了对根目录的特殊处理
- 修改前：直接从请求URI中减去BASE_URL长度
- 修改后：判断BASE_URL是否为根目录，如果是则不需要额外处理
- 修改文件：`index.php`

### 技术说明
- 在IIS服务器上，当应用部署在根目录时，路由处理需要特殊考虑
- 通过检查BASE_URL是否为"/"来判断是否为根目录部署
- 根据不同的部署方式，使用不同的路由解析逻辑

## 环境配置修复

### 问题描述
系统环境配置存在问题，导致在不同环境下行为不一致。

### 修复内容
- 在config.php中，当DEBUG_MODE为false时，系统应该处于测试环境，否则应该处于生产环境
- 修改了环境检测逻辑，确保在不同环境下系统行为一致
- 添加了环境相关的配置项，方便根据不同环境调整系统行为

### 技术说明
- DEBUG_MODE为true时，系统会输出详细的调试信息，适合开发环境
- DEBUG_MODE为false时，系统会隐藏错误信息，适合生产环境
- 通过环境配置，可以在不修改代码的情况下，调整系统在不同环境下的行为

## 部署配置修复

### 问题描述
系统部署配置存在问题，导致在IIS服务器上无法正常运行。

### 修复内容
- 修改了部署配置，确保系统可以在IIS服务器上正常运行
- 程序将在IIS服务器上运行，不应使用public/目录进行前后端分离，根目录应该是index.php所在的位置
- 修改了文件路径处理逻辑，确保在不同服务器环境下路径处理一致

### 技术说明
- IIS服务器与Apache服务器在路径处理上存在差异
- 通过统一路径处理逻辑，确保系统在不同服务器环境下行为一致
- 移除了对public/目录的依赖，简化了部署流程

## 调试功能修复

### 问题描述
系统调试功能存在问题，导致无法有效进行调试。

### 修复内容
- 不使用error_log()方法进行调试，因为它不是PHP或项目的原生方法，在远程IIS服务器上无法正常工作
- 移除了输出文件内容的调试代码，防止调试文件过度膨胀
- 添加了适合IIS环境的调试工具，替代不适用的error_log()方法
- 在Utils类中添加了debug()方法，将调试信息写入到logs/debug.log文件中
- 只在DEBUG_MODE开启时记录日志，不影响生产环境性能

### 技术说明
- 自定义的调试方法更适合项目需求，可以根据不同环境调整调试行为
- 通过控制调试信息的输出，避免调试文件过度膨胀
- 调试信息只在开发环境中记录，不影响生产环境性能

## PHP兼容性修复

### 问题描述
系统中存在PHP兼容性问题，导致在不同PHP版本下行为不一致。

### 修复内容
- 修复了strpos()函数参数类型问题，确保在PHP 7.4及以上版本中不会出现废弃警告
- 在CardParser::getCardAuthor()方法中，添加了显式类型转换：$prefixStr = (string)$prefix
- 确保传递给strpos()的参数是字符串类型
- 检查了CardParser.php文件中的所有strpos()调用，确认其他调用中的参数都已经是字符串类型

### 技术说明
- PHP 7.4及以上版本会对使用非字符串参数调用strpos()函数发出废弃警告
- 在PHP 8.0中，这种用法将导致错误
- 通过显式类型转换可以确保代码在未来版本的PHP中仍然正常工作
- 这种修复不会改变代码的功能，只是使其更加符合PHP的最佳实践
