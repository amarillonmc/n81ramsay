# 作者管理功能与修复

## 目录

1. [作者信息解析](#作者信息解析)
2. [作者管理功能](#作者管理功能)
3. [作者编辑功能](#作者编辑功能)
4. [作者前缀编辑功能](#作者前缀编辑功能)
5. [作者光荣榜](#作者光荣榜)
6. [作者识别修复](#作者识别修复)
7. [技术总结](#技术总结)

## 作者信息解析

### 功能描述
实现了解析卡片作者的功能，并在卡片详情页面中增加栏位，显示卡片作者信息。

### 作者信息来源
卡片作者信息有两种来源：
1. 在 CARD_DATA_PATH 下的 strings.conf 文件中，作者会声明自己的卡片区间以及系列区间，这些信息会记录在该文件中以 # 开头的注释内。
   例如：`#少年 714 0x710-0x71f Sonic_714`
   - 作者名称为"少年"
   - 卡片区间为714（卡片ID以该数字起头）
   - 系列区间为0x710-0x71f

2. 作者在卡片的描述中签名，格式为 DoItYourself 或 DIY（不分大小写）加分隔符加作者ID。
   例如：`DoItYourself-- galeЖomari`
   - 作者为"galeЖomari"

如果同时满足两种条件，则第二种条件（卡片描述中的签名）优先。

### 实现内容

1. 在 CardParser 类中添加作者相关属性和方法
   - 添加了 `$authors` 属性，用于存储作者信息
   - 添加了 `loadAuthors()` 方法，用于从 strings.conf 文件中加载作者信息
   - 添加了 `getCardAuthor()` 方法，用于获取卡片的作者信息

2. 修改卡片数据处理方法
   - 修改了 `getCardsFromDatabase()`、`getCardById()` 和 `searchCards()` 方法，添加作者信息到卡片数据中

3. 修改卡片详情页面
   - 在卡片详情页面中添加了显示卡片作者的栏位
   - 只有当卡片有作者信息时才显示该栏位

## 作者管理功能

### 功能概述

实现了作者管理功能，允许管理员（等级2以上）管理卡片作者信息。主要功能包括：

1. 自动识别作者：管理员可以通过按下"识别作者"按钮，预先通过已有的作者识别方法填充卡片ID区间和对应作者。
2. 手动添加作者：管理员可以手动添加卡片ID区间及对应作者，包括作者别名、联系方式和备注等详细信息。
3. 编辑作者信息：管理员可以编辑已有的作者信息，包括作者名称、别名、联系方式和备注。
4. 删除作者映射：管理员可以删除不需要的作者映射。
5. 作者识别优先级调整：在识别作者时，优先使用数据库中的作者映射，其次是卡片描述中的作者信息，最后是通过strings.conf识别的信息。

### 实现内容

#### 1. 数据库表

创建了`author_mappings`表，用于存储作者映射信息：

```sql
CREATE TABLE IF NOT EXISTS author_mappings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    card_prefix TEXT NOT NULL,
    author_name TEXT NOT NULL,
    alias TEXT,
    contact TEXT,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (card_prefix)
)
```

#### 2. 模型类

创建了`AuthorMapping`模型类，提供以下方法：

- `getAllAuthorMappings()`: 获取所有作者映射
- `getAuthorMappingByPrefix($cardPrefix)`: 根据卡片前缀获取作者映射
- `addAuthorMapping($cardPrefix, $authorName, $alias, $contact, $notes)`: 添加作者映射
- `updateAuthorMapping($cardPrefix, $authorName, $alias, $contact, $notes)`: 更新作者映射
- `deleteAuthorMapping($cardPrefix)`: 删除作者映射
- `importAuthorMappings($mappings)`: 批量导入作者映射
- `identifyAuthorsFromStringsConf()`: 从strings.conf文件中识别作者并导入

#### 3. 控制器方法

在`AdminController`中添加了以下方法：

- `authors()`: 作者管理页面
- `identifyAuthors()`: 识别作者
- `addAuthor()`: 添加作者映射
- `editAuthor()`: 编辑作者映射
- `deleteAuthor()`: 删除作者映射

#### 4. 视图文件

创建了以下视图文件：

1. `includes/Views/admin/authors.php`：作者管理主页面，包含以下内容：
   - 识别作者按钮
   - 添加作者表单
   - 作者列表表格（包含编辑和删除按钮）

2. `includes/Views/admin/edit_author.php`：编辑作者页面，包含以下内容：
   - 编辑作者表单
   - 保存和返回按钮

#### 5. 导航菜单

在`includes/Views/layout.php`中添加了作者管理的导航链接，仅对管理员等级2以上的用户显示。

#### 6. 作者识别逻辑修改

修改了`CardParser::getCardAuthor()`方法，调整了作者识别的优先级：

1. 首先检查数据库中的作者映射
2. 其次检查卡片描述中的作者签名
3. 最后根据strings.conf中的作者信息查找

## 作者编辑功能

### 功能描述

实现了作者信息编辑功能，允许管理员编辑已有的作者信息。

### 实现内容

1. 添加了编辑作者页面，包含以下字段：
   - 卡片前缀（只读）
   - 作者名称
   - 作者别名
   - 联系方式
   - 备注

2. 实现了编辑作者的控制器方法：
   - 获取现有作者信息
   - 验证表单数据
   - 更新作者信息
   - 重定向回作者管理页面

3. 添加了表单验证：
   - 确保作者名称不为空
   - 验证卡片前缀格式

4. 添加了成功/错误消息提示

## 作者前缀编辑功能

### 功能描述

实现了作者前缀编辑功能，允许管理员修改卡片前缀。

### 实现内容

1. 在编辑作者页面中添加了修改卡片前缀的功能
2. 添加了卡片前缀验证，确保前缀是有效的数字
3. 实现了更新卡片前缀的控制器方法
4. 添加了唯一性检查，确保不会与现有前缀冲突

## 作者光荣榜

### 功能描述

实现了作者光荣榜功能，展示所有卡片作者的统计数据。

### 实现内容

1. 添加了作者光荣榜页面，显示以下信息：
   - 作者名称
   - 投稿卡片数量
   - 禁卡比例
   - 被禁系列数量

2. 实现了作者统计数据计算：
   - 统计每位作者的卡片数量
   - 计算每位作者的禁卡比例
   - 统计每位作者的被禁系列数量

3. 实现了排序功能：
   - 按投稿卡片数量从高到低排序
   - 同等卡片数量的作者按禁卡比例从高到低排序
   - 将未知作者放在最后显示

4. 添加了配置选项，允许管理员配置作者光荣榜的显示方式

### 优化内容

1. 禁卡表优化：
   - 在计算禁卡比例时，排除了"#Forbidden TCG"下的卡片，因为这些不是服务器作者创建的
   - 优化了禁卡表解析逻辑，提高性能

2. 计算修复：
   - 修复了作者光荣榜计算中的错误，确保数据准确性
   - 优化了大量数据的处理性能

3. 排序优先级更新：
   - 修改了排序逻辑，优先按投稿卡片数量从高到低排序
   - 将未知作者和ID前缀作者放在已知作者之后显示

## 作者识别修复

### 问题描述

1. 作者签名解析问题：
   在解析卡片描述中的作者签名时，分隔符（如 `-`、`—`、空格等）被错误地包含在了作者名中。例如，对于描述中包含 `DoItYourself-- galeЖomari` 的卡片，显示的作者名是 `- galeЖomari`，而正确的作者名应该是 `galeЖomari`。

2. 特殊字符处理问题：
   在卡片描述中，当作者名包含特殊字符（如日文假名"の"）时，系统只能识别出部分作者名。例如，对于"——DoItYourself 极の一击"，系统只识别出"极"作为作者名，而丢失了"の一击"部分。

### 修复内容

1. 改进作者签名正则表达式：
   - 修改了 `getCardAuthor()` 方法中的正则表达式，以更好地匹配各种分隔符
   - 新的正则表达式支持多种格式，包括使用不同分隔符和 "by" 关键字的情况

2. 添加额外的清理步骤：
   - 在匹配到作者名后，添加了额外的清理步骤
   - 使用 `preg_replace` 移除作者名开头可能存在的分隔符
   - 使用 `trim` 移除作者名两端的空白字符

3. 特殊字符处理：
   - 添加了对特殊字符的检测：使用 `/[^\x00-\x7F]/` 正则表达式检测作者名是否包含非ASCII字符
   - 对于包含特殊字符的作者名，不进行单词截断处理，保留完整的作者名
   - 只对纯英文名称（只包含英文字母、数字和基本标点）进行单词截断处理
   - 保留了对方括号等标记的处理，确保作者名不包含不必要的标记

4. 简化模式配置：
   - 在config.php中添加了简化作者识别模式选项，该模式下只使用管理员管理的作者列表进行识别（默认：false）

## 技术总结

1. 作者信息解析
   - 作者信息解析使用正则表达式匹配 strings.conf 文件中的作者声明
   - 支持多个卡片区间和系列区间的解析
   - 卡片描述中的作者签名解析支持多种分隔符
   - 新的正则表达式：`/(?:DoItYourself|DIY)(?:\s*[-—_:：]+\s*|\s+by\s+)([^\n\r]+)/i`

2. 作者识别优先级
   - 管理员记录的信息 > 卡片描述文本 > strings.conf数据
   - 当无法直接确定卡片作者时，检查卡片ID的前三位数字，并将其与strings.conf注释中的作者信息匹配

3. 作者名称处理
   - 对于包含特殊字符的作者名，保留完整名称
   - 对于纯英文名称，可能会进行单词截断处理
   - 移除作者名中的不必要标记和分隔符
