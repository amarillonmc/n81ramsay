# 投票者封禁功能和管理员菜单整合文档

## 修改时间
2024年12月24日

## 功能概述
1. 为2级以上管理员添加了封禁特定VoterIdentifier的功能
2. 整合了所有管理员功能到一个下拉菜单中，解决导航栏拥挤问题

## 修改内容

### 1. 数据库层修改

#### 新增投票者封禁表
**文件**: `includes/Core/Database.php`
- 添加了 `voter_bans` 表，包含以下字段：
  - `id`: 主键
  - `voter_identifier`: 投票者标识符（唯一）
  - `ban_level`: 封禁等级（1或2）
  - `reason`: 封禁理由
  - `banned_by`: 封禁操作者
  - `banned_at`: 封禁时间
  - `is_active`: 是否活跃（1=活跃，0=已解封）

### 2. 模型层修改

#### 新增VoterBan模型
**文件**: `includes/Models/VoterBan.php`
- `addBan()`: 添加封禁记录
- `updateBan()`: 更新封禁记录
- `removeBan()`: 解除封禁
- `getBanByIdentifier()`: 根据标识符获取封禁记录
- `getAllActiveBans()`: 获取所有活跃封禁记录
- `checkBan()`: 检查投票者是否被封禁
- `logBanAction()`: 记录封禁操作日志
- 静态方法：`getBanLevelText()`, `getBanLevelClass()`

### 3. 控制器层修改

#### AdminController扩展
**文件**: `includes/Controllers/AdminController.php`
- 添加了 `$voterBanModel` 属性
- `voterBans()`: 封禁管理页面
- `addVoterBan()`: 添加封禁
- `removeVoterBan()`: 解除封禁

#### VoteController修改
**文件**: `includes/Controllers/VoteController.php`
- 添加了 `$voterBanModel` 属性
- 在投票处理逻辑中添加封禁检查：
  - 等级2封禁：完全禁止投票
  - 等级1封禁：要求评论长度达到 `SERIES_VOTING_REASON_MIN_LENGTH`

### 4. 视图层修改

#### 新增封禁管理页面
**文件**: `includes/Views/admin/voter_bans.php`
- 封禁添加表单（投票者标识符、封禁等级、理由）
- 当前封禁列表（表格显示）
- 解封操作按钮
- 完整的CSS样式和JavaScript交互

#### 投票详情页面修改
**文件**: `includes/Views/votes/vote.php`
- 为每个投票记录检查封禁状态
- 显示封禁指示器：
  - 等级1：黄色警告图标 "受限"
  - 等级2：红色禁止图标 "封禁"
- 弱化显示不计入统计的投票（等级1封禁且理由不足）
- 添加相关CSS样式

#### 管理员导航菜单整合
**文件**: `includes/Views/layout.php`
- 将所有管理员功能整合到下拉菜单中
- 按权限等级分组显示
- 添加分隔线区分不同权限等级的功能

### 5. 样式和交互

#### CSS样式
**文件**: `assets/css/style.css`
- 下拉菜单样式（`.dropdown`, `.dropdown-menu`等）
- 封禁指示器样式（`.ban-indicator`, `.weakened-indicator`）
- 弱化投票记录样式（`.vote-record-weakened`）

#### JavaScript交互
**文件**: `assets/js/script.js`
- 下拉菜单点击切换功能
- 点击外部区域关闭菜单
- 防止菜单内部点击事件冒泡

### 6. 日志系统

#### 封禁操作日志
- 日志文件：`/logs/voterBan_YYYY-MM-DD.txt`
- 记录内容：
  - 操作时间戳
  - 操作类型（ban/unban）
  - 操作者信息
  - 投票者标识符
  - 封禁等级和理由

## 封禁等级说明

### 等级1：限制投票
- 用户仍可进行投票操作
- 如果评论长度未达到 `SERIES_VOTING_REASON_MIN_LENGTH`，投票不计入统计
- 在页面上弱化显示（透明度降低，左侧黄色边框）
- 显示黄色"受限"标识

### 等级2：禁止投票
- 用户完全无法进行投票操作
- 尝试投票时直接返回错误信息
- 显示红色"封禁"标识

## 管理员功能菜单结构

```
管理员功能 ▼
├── 投票管理 (等级1+)
├── 禁卡表整理 (等级1+)
├── 召唤词管理 (等级1+)
├── ──────────── (分隔线)
├── 作者管理 (等级2+)
├── 服务器提示管理 (等级2+)
└── 投票者封禁管理 (等级2+)
```

## 权限要求

- **封禁管理**: 等级2以上管理员
- **投票限制检查**: 自动应用于所有用户
- **封禁状态显示**: 所有用户可见

## 技术特性

### 1. 数据完整性
- 投票者标识符唯一性约束
- 封禁状态的软删除机制（is_active字段）
- 完整的操作日志记录

### 2. 用户体验
- 直观的封禁管理界面
- 清晰的封禁状态指示
- 整洁的管理员导航菜单

### 3. 安全性
- 严格的权限检查
- 操作确认对话框
- 详细的审计日志

### 4. 性能优化
- 高效的封禁状态检查
- 最小化数据库查询
- 合理的缓存策略

## 使用说明

### 1. 封禁用户
1. 以等级2+管理员身份登录
2. 点击"管理员功能" → "投票者封禁管理"
3. 在左侧表单中输入投票者标识符、选择封禁等级、填写理由
4. 点击"添加封禁"

### 2. 解封用户
1. 在封禁列表中找到目标用户
2. 点击"解封"按钮
3. 确认操作

### 3. 查看封禁效果
- 等级1封禁：投票记录显示为弱化状态，带"受限"标识
- 等级2封禁：用户无法投票，带"封禁"标识

## 配置项

无新增配置项，使用现有的 `SERIES_VOTING_REASON_MIN_LENGTH` 配置来判断等级1封禁的理由长度要求。

## 兼容性

- 完全向后兼容现有功能
- 不影响现有投票数据
- 平滑的用户界面升级

## 测试建议

1. 测试封禁添加和解除功能
2. 测试不同等级封禁的投票限制
3. 测试封禁状态的页面显示
4. 测试管理员下拉菜单的交互
5. 测试权限控制的正确性
6. 测试日志记录功能
