# 2023-11-09 卡片功能实现与修复记录

## 一、卡片详情显示修复

### 问题描述
卡片详情页面中存在以下问题：
1. 类别显示为空白或"未知类别"（括号中解析的十六进制数是正确的）
2. 种族显示为"未知种族"（括号中解析的十六进制数是正确的）
3. 属性显示为"未知属性"（括号中解析的十六进制数是正确的）

### 修复过程

#### 1. 初步修复
- 修改了 `getTypeText()`、`getRaceText()` 和 `getAttributeText()` 方法，使其能够正确解析卡片信息
- 使用直接比较十进制值的方式查找匹配的代码
- 确保十六进制转换正确
- 使用"·"而不是"/"作为类型分隔符，符合中文习惯

#### 2. 调试工具改进
- 添加了适合IIS环境的调试工具，替代不适用的 error_log() 方法
- 在Utils类中添加了debug()方法，将调试信息写入到logs/debug.log文件中
- 只在DEBUG_MODE开启时记录日志，不影响生产环境性能

#### 3. 文件解析改进
- 改进了 `loadCardInfoMappings()` 方法，使其能够更好地处理文件格式
- 使用 `preg_split('/[\t\s]+/', $line, 2)` 替代 `explode("\t", $line)` 来处理可能的空格和制表符混合情况
- 统一行结束符处理：`$content = str_replace(["\r\n", "\r"], "\n", $content);`

#### 4. 硬编码解决方案
- 添加了 `hardcodeCardInfoMappings()` 方法，直接在代码中定义类型、种族和属性映射
- 在 `loadCardInfoMappings()` 方法开始时调用这个方法，确保即使文件解析失败，也能有基本的映射数据
- 硬编码的映射数据基于游戏王卡片的标准类型、种族和属性定义

#### 5. 类型文本排序优化
- 修改了 `getTypeText()` 方法，对类型进行排序，确保主要类型（怪兽/魔法/陷阱）在前面
- 将类型分为主要类型和子类型，先显示主要类型，再显示子类型
- 确保类型文本的显示顺序符合游戏王卡片的惯例（如"魔法·速攻"而不是"速攻·魔法"）

#### 6. 调试代码清理
- 移除了过多的调试输出，避免调试文件过度膨胀
- 保留了核心功能和必要的调试信息

## 二、卡片作者功能实现

### 功能描述
实现了解析卡片作者的功能，并在卡片详情页面中增加栏位，显示卡片作者信息。

### 作者信息来源
卡片作者信息有两种来源：
1. 在 CARD_DATA_PATH 下的 strings.conf 文件中，作者会声明自己的卡片区间以及系列区间，这些信息会记录在该文件中以 # 开头的注释内。
   例如：`#少年 714 0x710-0x71f Sonic_714`
   - 作者名称为"少年"
   - 卡片区间为714（卡片ID以该数字起头）
   - 系列区间为0x710-0x71f

2. 作者在卡片的描述中签名，格式为 DoItYourself 或 DIY（不分大小写）加分隔符加作者ID。
   例如：`DoItYourself-- galeЖomari`
   - 作者为"galeЖomari"

如果同时满足两种条件，则第二种条件（卡片描述中的签名）优先。

### 实现内容

#### 1. 在 CardParser 类中添加作者相关属性和方法
- 添加了 `$authors` 属性，用于存储作者信息
- 添加了 `loadAuthors()` 方法，用于从 strings.conf 文件中加载作者信息
- 添加了 `getCardAuthor()` 方法，用于获取卡片的作者信息

#### 2. 修改卡片数据处理方法
- 修改了 `getCardsFromDatabase()`、`getCardById()` 和 `searchCards()` 方法，添加作者信息到卡片数据中

#### 3. 修改卡片详情页面
- 在卡片详情页面中添加了显示卡片作者的栏位
- 只有当卡片有作者信息时才显示该栏位

### 作者解析修复

#### 问题描述
在解析卡片描述中的作者签名时，分隔符（如 `-`、`—`、空格等）被错误地包含在了作者名中。例如，对于描述中包含 `DoItYourself-- galeЖomari` 的卡片，显示的作者名是 `- galeЖomari`，而正确的作者名应该是 `galeЖomari`。

#### 修复内容

1. 改进作者签名正则表达式
   - 修改了 `getCardAuthor()` 方法中的正则表达式，以更好地匹配各种分隔符
   - 新的正则表达式支持多种格式，包括使用不同分隔符和 "by" 关键字的情况

2. 添加额外的清理步骤
   - 在匹配到作者名后，添加了额外的清理步骤
   - 使用 `preg_replace` 移除作者名开头可能存在的分隔符
   - 使用 `trim` 移除作者名两端的空白字符

## 技术总结

1. 卡片信息解析
   - 卡片类别（type）是一个位掩码，可能包含多个类型值的组合
   - 种族（race）和属性（attribute）是单一值，直接对应一个十六进制代码
   - 所有这些值都在 `res/cardinfo_chinese.txt` 文件中定义

2. 作者信息解析
   - 作者信息解析使用正则表达式匹配 strings.conf 文件中的作者声明
   - 支持多个卡片区间和系列区间的解析
   - 卡片描述中的作者签名解析支持多种分隔符
   - 新的正则表达式：`/(?:DoItYourself|DIY)(?:\s*[-—_:：]+\s*|\s+by\s+)([^\n\r]+)/i`

3. 调试与错误处理
   - 使用自定义的 Utils::debug() 方法记录调试信息
   - 调试信息写入到 logs/debug.log 文件中
   - 只在 DEBUG_MODE 开启时记录日志，不影响生产环境性能
