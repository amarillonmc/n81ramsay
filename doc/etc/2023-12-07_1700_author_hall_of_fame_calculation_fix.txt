# 2023-12-07 17:00 - 作者榜单计算修复

修复了作者榜单在简略识别模式下可能出现的卡片数量计算错误和重复计算问题。

## 问题描述

在简略识别模式下，作者榜单可能会出现以下问题：

1. 某些作者的卡片数量和禁卡数量异常高
2. 同一张卡片可能被重复计算
3. 不同数据库文件中的相同卡片可能被重复计算

## 修复内容

1. 添加了卡片ID去重机制，防止同一张卡片被重复统计：

```php
// 已处理的卡片ID集合，用于防止重复统计
$processedCardIds = [];

// 在处理卡片时检查是否已经统计过
$cardId = (int)$card['id'];
if (isset($processedCardIds[$cardId])) {
    continue;
}
$processedCardIds[$cardId] = true;
```

2. 优化了简略识别模式下的作者识别逻辑，预先加载所有作者映射，提高效率并减少重复查询：

```php
// 如果是简略识别模式，预先加载所有作者映射
$authorMappings = [];
if (defined('AUTHOR_HALL_OF_FAME_SIMPLE_MODE') && AUTHOR_HALL_OF_FAME_SIMPLE_MODE) {
    $db = Database::getInstance();
    $mappings = $db->getRows('SELECT * FROM author_mappings');
    foreach ($mappings as $mapping) {
        $authorMappings[$mapping['card_prefix']] = $mapping['author_name'];
    }
}
```

3. 添加了新的 `getAuthorFromMappings` 方法，从预加载的作者映射中获取作者信息：

```php
/**
 * 从预加载的作者映射中获取作者信息
 *
 * @param array $card 卡片信息
 * @param array $authorMappings 预加载的作者映射
 * @return string 作者名称
 */
private function getAuthorFromMappings($card, $authorMappings) {
    $cardId = (string)$card['id'];
    
    // 尝试使用卡片ID前缀查找作者映射
    if (strlen($cardId) >= 3) {
        $cardPrefix = substr($cardId, 0, 3);
        
        if (isset($authorMappings[$cardPrefix])) {
            return $authorMappings[$cardPrefix];
        }
    }
    
    // 如果找不到作者信息，返回"未知作者"
    return "未知作者";
}
```

## 修复效果

1. 防止了同一张卡片被重复统计，确保每张卡片只被计算一次
2. 优化了作者识别逻辑，提高了效率并减少了重复查询
3. 修复了简略识别模式下可能出现的卡片数量计算错误

这些修改确保了作者榜单在简略识别模式下的统计数据更加准确，避免了异常高的卡片数量和禁卡数量。
