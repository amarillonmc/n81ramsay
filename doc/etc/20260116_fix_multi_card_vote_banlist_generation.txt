修改时间：2026-01-16
修改内容：修复投票生成禁卡表功能中多卡投票的BUG

问题描述：
对于高级投票（影响多张卡的投票）和系列投票，系统无法自动生成正确的禁卡表行。
禁卡表的解析中会将这些多卡投票作为针对其第一张卡的投票结果处理，导致其他卡片的投票结果被忽略。
管理员仍需要人工处理这些多卡投票的结果。

根本原因：
includes/Models/Vote.php 中的 getVoteResults() 方法只处理了 vote 表中的 card_id 字段，
没有处理：
1. 高级投票的 card_ids 字段（JSON数组，包含多张卡片ID）
2. 系列投票的 setcode 字段（需要查询该系列的所有卡片）

修改方案：
修改 getVoteResults() 方法，使其能够：
1. 检测投票类型（普通投票、高级投票、系列投票）
2. 对于高级投票：解析 card_ids JSON数组，为每张卡片生成独立的结果条目
3. 对于系列投票：通过 setcode 查询系列卡片，为每张卡片生成独立的结果条目
4. 对于普通投票：保持原有逻辑不变

修改文件：
- includes/Models/Vote.php

修改详情：

1. 在 getVoteResults() 方法中添加投票类型判断：
   - 读取 is_advanced_vote 和 is_series_vote 标志
   
2. 根据投票类型确定需要处理的卡片ID列表：
   - 高级投票：从 card_ids 字段解析JSON数组
   - 系列投票：通过 cardModel->getCardsBySetcode() 获取系列卡片
   - 普通投票：使用 card_id 字段
   
3. 为每张卡片生成独立的投票结果条目：
   - 对于高级投票：调用 getVoteStats($voteId, $cardId) 获取该卡片的单独统计
   - 对于系列投票和普通投票：调用 getVoteStats($voteId) 获取共享统计
   
4. 在结果数组中添加投票类型标识：
   - 添加 is_advanced_vote 和 is_series_vote 字段

影响范围：
- 禁卡表生成功能（BanlistController::generate()）
- 禁卡表管理页面（BanlistController::index()）
- 禁卡表应用功能（BanlistController::apply()）

预期效果：
1. 高级投票中的每张卡片都会在禁卡表中生成独立的条目
2. 系列投票中的每张系列卡片都会在禁卡表中生成独立的条目
3. 管理员无需再手动处理多卡投票的结果
4. 禁卡表生成功能完全自动化

测试建议：
1. 创建一个高级投票，包含多张卡片
2. 创建一个系列投票
3. 在禁卡表管理页面查看投票结果，确认每张卡片都有独立的结果条目
4. 生成禁卡表，确认所有卡片都正确包含在禁卡表中

