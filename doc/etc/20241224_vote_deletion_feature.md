# 投票删除功能实装文档

## 修改时间
2024年12月24日

## 功能概述
实装了删除/撤回单个投票的功能，允许管理员和投票者本人（在配置允许的情况下）删除投票记录。

## 修改内容

### 1. 配置项添加
**文件**: `config.php`
- 添加了 `ALLOW_VOTE_DELETION` 配置项，默认值为 `true`
- 控制普通用户是否能删除自己的投票记录

### 2. 数据库模型层修改
**文件**: `includes/Models/Vote.php`
- 添加了 `deleteVoteRecord($recordId)` 方法：删除指定的投票记录
- 添加了 `getVoteRecordById($recordId)` 方法：根据ID获取投票记录
- 添加了 `isVoteRecordOwnedByUser($recordId, $identifier)` 方法：检查投票记录是否属于指定用户

### 3. 控制器层修改
**文件**: `includes/Controllers/VoteController.php`
- 添加了 `deleteRecord()` 方法：处理删除投票记录的请求
- 添加了 `logVoteDeletion($record, $vote, $operatorInfo)` 方法：记录删除操作日志
- 实现了完整的权限检查逻辑：
  - 管理员（等级1以上）可以删除任何投票记录
  - 普通用户（在配置允许时）可以删除自己的投票记录
  - 只有未关闭的投票才能删除记录

### 4. 视图层修改
**文件**: `includes/Views/votes/vote.php`
- 在投票记录显示区域添加了删除按钮
- 根据用户权限动态显示/隐藏删除按钮
- 添加了完整的前端JavaScript处理逻辑：
  - 确认对话框
  - AJAX删除请求
  - 动态更新页面内容
  - 错误处理和用户反馈

### 5. 日志系统
- 删除操作会记录到 `/logs/deletedVote_YYYY-MM-DD.txt` 文件中
- 日志包含以下信息：
  - 操作时间戳
  - 操作者信息（管理员用户名或用户标识符）
  - 投票信息（投票ID、链接、卡片ID等）
  - 被删除的投票记录详情

## 权限控制

### 管理员权限
- 等级1以上的管理员可以删除任何投票记录
- 操作会记录为 `Admin:用户名`

### 普通用户权限
- 需要 `ALLOW_VOTE_DELETION` 配置为 `true`
- 只能删除自己的投票记录（通过VoterIdentifier匹配）
- 操作会记录为 `User:标识符`

### 限制条件
- 只有未关闭的投票才能删除记录
- 删除后原投票者可以重新投票

## 用户界面

### 删除按钮
- 位置：每个投票记录的右侧
- 样式：小型红色轮廓按钮，带垃圾桶图标
- 显示条件：
  - 投票未关闭
  - 用户有删除权限

### 交互流程
1. 用户点击删除按钮
2. 显示确认对话框
3. 确认后发送AJAX请求
4. 按钮显示加载状态
5. 成功后移除记录并更新计数
6. 失败时显示错误消息

## 技术实现细节

### 用户身份验证
- 使用IP地址和用户ID生成的VoterIdentifier进行匹配
- 确保只有原投票者才能删除自己的记录

### 数据完整性
- 删除前验证投票记录存在性
- 验证投票记录与投票的关联关系
- 检查投票状态（是否已关闭）

### 错误处理
- 完整的参数验证
- 权限检查失败的友好提示
- 网络错误的重试机制

## 配置说明

```php
// 在 config.php 中的新配置项
if (!defined('ALLOW_VOTE_DELETION')) {
    define('ALLOW_VOTE_DELETION', true); // 是否允许用户删除自己的投票
}
```

## 日志格式示例

```json
{
    "timestamp": "2024-12-24 15:30:45",
    "operator": "Admin:admin",
    "vote_info": {
        "vote_id": 123,
        "vote_link": "abc12345",
        "card_id": 12345678,
        "environment_id": 1,
        "vote_cycle": 5
    },
    "deleted_record": {
        "record_id": 456,
        "user_id": "TestUser",
        "identifier": "abc123def",
        "status": 0,
        "comment": "测试评论",
        "created_at": "2024-12-24 14:20:30"
    }
}
```

## 安全考虑

1. **权限验证**：严格的权限检查，防止越权操作
2. **身份验证**：基于IP和用户ID的双重验证
3. **操作日志**：完整记录所有删除操作，便于审计
4. **状态检查**：只允许删除未关闭投票的记录
5. **参数验证**：全面的输入参数验证

## 测试建议

1. 测试管理员删除功能
2. 测试普通用户删除自己的投票
3. 测试普通用户无法删除他人投票
4. 测试已关闭投票无法删除记录
5. 测试配置关闭时用户无法删除
6. 测试日志记录功能
7. 测试前端交互和错误处理
