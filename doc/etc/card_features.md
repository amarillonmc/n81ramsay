# 卡片功能与修复

## 目录

1. [卡片详情显示](#卡片详情显示)
2. [卡片分页功能](#卡片分页功能)
3. [卡片图片显示](#卡片图片显示)
4. [卡片数据库配置](#卡片数据库配置)
5. [技术总结](#技术总结)

## 卡片详情显示

### 问题描述
卡片详情页面中存在以下问题：
1. 类别显示为空白或"未知类别"（括号中解析的十六进制数是正确的）
2. 种族显示为"未知种族"（括号中解析的十六进制数是正确的）
3. 属性显示为"未知属性"（括号中解析的十六进制数是正确的）

### 修复内容

#### 1. 初步修复
- 修改了 `getTypeText()`、`getRaceText()` 和 `getAttributeText()` 方法，使其能够正确解析卡片信息
- 使用直接比较十进制值的方式查找匹配的代码
- 确保十六进制转换正确
- 使用"·"而不是"/"作为类型分隔符，符合中文习惯

#### 2. 调试工具改进
- 添加了适合IIS环境的调试工具，替代不适用的 error_log() 方法
- 在Utils类中添加了debug()方法，将调试信息写入到logs/debug.log文件中
- 只在DEBUG_MODE开启时记录日志，不影响生产环境性能

#### 3. 文件解析改进
- 改进了 `loadCardInfoMappings()` 方法，使其能够更好地处理文件格式
- 使用 `preg_split('/[\t\s]+/', $line, 2)` 替代 `explode("\t", $line)` 来处理可能的空格和制表符混合情况
- 统一行结束符处理：`$content = str_replace(["\r\n", "\r"], "\n", $content);`

#### 4. 硬编码解决方案
- 添加了 `hardcodeCardInfoMappings()` 方法，直接在代码中定义类型、种族和属性映射
- 在 `loadCardInfoMappings()` 方法开始时调用这个方法，确保即使文件解析失败，也能有基本的映射数据
- 硬编码的映射数据基于游戏王卡片的标准类型、种族和属性定义

#### 5. 类型文本排序优化
- 修改了 `getTypeText()` 方法，对类型进行排序，确保主要类型（怪兽/魔法/陷阱）在前面
- 将类型分为主要类型和子类型，先显示主要类型，再显示子类型
- 确保类型文本的显示顺序符合游戏王卡片的惯例（如"魔法·速攻"而不是"速攻·魔法"）

#### 6. 调试代码清理
- 移除了过多的调试输出，避免调试文件过度膨胀
- 保留了核心功能和必要的调试信息

#### 7. strpos() 函数参数类型修复
- 修复了 PHP 未来版本中将不再支持将非字符串参数自动转换为字符串的问题
- 在 `getCardAuthor()` 方法中，添加了显式类型转换：`$prefixStr = (string)$prefix`
- 确保传递给 `strpos()` 的参数是字符串类型
- 检查了 CardParser.php 文件中的所有 `strpos()` 调用，确认其他调用中的参数都已经是字符串类型

## 卡片分页功能

### 功能描述
实现了卡片列表的分页功能，提高大量卡片浏览的效率。

### 实现内容
1. 添加了分页控制器方法，支持获取指定页码的卡片数据
2. 实现了分页导航组件，包括首页、上一页、页码列表、下一页、末页等按钮
3. 支持自定义每页显示的卡片数量（10/20/50/100）
4. 添加了页码和总页数显示
5. 优化了分页性能，只查询当前页需要的数据

### 使用方法
1. 在卡片列表页面底部，用户可以选择每页显示的卡片数量
2. 点击分页导航按钮可以切换到不同的页面
3. 当前页码会高亮显示
4. 页面顶部显示当前显示的卡片范围和总卡片数量

## 卡片图片显示

### 功能描述
实现了卡片图片的显示功能，支持从服务器获取卡图。

### 实现内容
1. 修改了卡片解析器中的图片路径处理逻辑，同时支持"c+卡片ID"和"卡片ID"两种格式
2. 使用web URL而非文件系统路径访问卡图
3. 卡图文件位于卡片数据库目录下的/pics/目录中，而非程序根目录
4. 添加了卡图缺失时的默认图片显示

## 卡片数据库配置

### 功能描述
实现了卡片数据库的配置功能，支持排除特定的数据库文件。

### 实现内容
1. 在config.php中添加了设置，用于排除特定文件（默认：Pre_Nerf_cards.cdb和SoundStageLib.cdb）
2. 修改了卡片解析器，使其在加载卡片数据时排除这些文件
3. 优化了卡片数据加载性能，避免加载不必要的数据

## 技术总结

1. 卡片信息解析
   - 卡片类别（type）是一个位掩码，可能包含多个类型值的组合
   - 种族（race）和属性（attribute）是单一值，直接对应一个十六进制代码
   - 所有这些值都在 `res/cardinfo_chinese.txt` 文件中定义

2. 调试与错误处理
   - 使用自定义的 Utils::debug() 方法记录调试信息
   - 调试信息写入到 logs/debug.log 文件中
   - 只在 DEBUG_MODE 开启时记录日志，不影响生产环境性能
