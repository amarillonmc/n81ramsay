# 优化投票概览页面

## 需求描述
优化投票概览页面，使其默认只显示当前周期的卡片，并折叠之前周期的卡片。

## 实现方案
1. 修改 Vote 模型的 getAllVotes 方法，添加按周期分组的功能
2. 修改 VoteController 的 index 方法，获取当前周期
3. 更新 votes/index.php 视图，实现按周期分组显示，默认只展开当前周期

## 修改内容

### 1. 修改 Vote 模型的 getAllVotes 方法
在 `includes\Models\Vote.php` 文件中，修改 getAllVotes 方法，添加 groupByCycle 参数，支持按周期排序：

```php
/**
 * 获取所有投票
 *
 * @param bool $includeClosedVotes 是否包含已关闭的投票
 * @param int $page 页码
 * @param int $perPage 每页数量
 * @param bool $groupByCycle 是否按周期分组
 * @return array 投票列表
 */
public function getAllVotes($includeClosedVotes = true, $page = 1, $perPage = 20, $groupByCycle = false) {
    $offset = ($page - 1) * $perPage;

    $sql = 'SELECT * FROM votes';
    $params = [];

    if (!$includeClosedVotes) {
        $sql .= ' WHERE is_closed = 0';
    }

    if ($groupByCycle) {
        // 按周期和创建时间排序
        $sql .= ' ORDER BY vote_cycle DESC, created_at DESC';
    } else {
        // 仅按创建时间排序
        $sql .= ' ORDER BY created_at DESC';
    }

    $sql .= ' LIMIT ? OFFSET ?';
    $params[] = $perPage;
    $params[] = $offset;

    return $this->db->getRows($sql, $params);
}
```

### 2. 修改 VoteController 的 index 方法
在 `includes\Controllers\VoteController.php` 文件中，修改 index 方法，获取当前周期并使用按周期分组的功能：

```php
/**
 * 投票列表
 */
public function index() {
    // 获取页码
    $page = isset($_GET['page']) ? (int)$_GET['page'] : 1;
    if ($page < 1) {
        $page = 1;
    }

    // 获取当前投票周期
    $db = Database::getInstance();
    $currentCycle = $db->getCurrentVoteCycle();

    // 获取投票列表（按周期分组）
    $votes = $this->voteModel->getAllVotes(true, $page, VOTES_PER_PAGE, true);
    $totalVotes = $this->voteModel->getVoteCount(true);

    // 计算总页数
    $totalPages = ceil($totalVotes / VOTES_PER_PAGE);

    // 处理投票数据
    foreach ($votes as &$vote) {
        // 获取卡片信息
        $card = $this->cardModel->getCardById($vote['card_id']);
        $vote['card'] = $card;

        // 获取环境信息
        $environment = Utils::getEnvironmentById($vote['environment_id']);
        $vote['environment'] = $environment;

        // 获取投票统计
        $vote['stats'] = $this->voteModel->getVoteStats($vote['id']);

        // 获取投票记录
        $vote['records'] = $this->voteModel->getVoteRecords($vote['id']);
    }
    // 解除引用，防止后续操作影响数组
    unset($vote);

    // 渲染视图
    include __DIR__ . '/../Views/layout.php';
    include __DIR__ . '/../Views/votes/index.php';
    include __DIR__ . '/../Views/footer.php';
}
```

### 3. 更新 votes/index.php 视图
在 `includes\Views\votes\index.php` 文件中，实现按周期分组显示，默认只展开当前周期：

- 按周期对投票进行分组
- 添加可折叠的周期标题
- 默认只展开当前周期的内容
- 添加JavaScript实现点击展开/折叠功能
- 添加CSS样式美化界面

## 效果
- 投票概览页面按周期分组显示
- 当前周期的投票默认展开，其他周期的投票默认折叠
- 用户可以点击周期标题展开或折叠对应周期的投票
- 当前周期有明显的标识，方便用户识别

## 修改时间
2024年6月24日
