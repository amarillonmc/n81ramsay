# 修复卡片排行榜中TCG卡片检测逻辑

## 问题描述
在卡片排行榜的"只看DIY卡排名"功能中，TCG卡片的检测逻辑存在问题。系统错误地将大部分TCG卡片标识为DIY卡片，导致在选择"只看DIY卡排名"选项时，仍然显示了大量TCG卡片。

## 原因分析
当前的检测逻辑是先尝试从DIY卡数据库中查找卡片，如果找不到，再从TCG卡数据库中查找。只有当卡片在DIY卡数据库中找不到，但在TCG卡数据库中找到时，才会将其标记为TCG卡片。

问题在于：有些卡片可能同时存在于DIY卡数据库和TCG卡数据库中，这种情况下，系统会错误地将其识别为DIY卡片。

## 修复方案
1. 修改卡片检测逻辑，先检查卡片是否存在于TCG卡数据库中
2. 如果卡片存在于TCG卡数据库中，则将其标记为TCG卡片，无论它是否也存在于DIY卡数据库中
3. 添加清除缓存功能，确保修改生效

## 修改内容

### 1. 修改 CardRanking.php 中的 processRankingData 方法

```php
// 处理每张卡的详细信息
foreach ($cardUsage as $cardId => $usage) {
    // 先检查卡片是否存在于TCG卡数据库中
    $isTcgCard = false;
    $tcgCardInfo = null;
    
    if (defined('TCG_CARD_DATA_PATH') && file_exists(TCG_CARD_DATA_PATH)) {
        $tcgCardInfo = $this->getTcgCardInfo($cardId);
        if ($tcgCardInfo) {
            $isTcgCard = true;
        }
    }
    
    // 从DIY卡数据库中查找卡片信息
    $cardInfo = $this->cardParser->getCardById($cardId);
    
    // 如果在DIY卡数据库中找不到，但在TCG卡数据库中找到，则使用TCG卡片信息
    if (!$cardInfo && $tcgCardInfo) {
        $cardInfo = $tcgCardInfo;
    }
    
    // 如果找不到卡片信息，则跳过
    if (!$cardInfo) {
        continue;
    }
    
    // 如果只显示DIY卡片且当前卡片是TCG卡片，则跳过
    if ($diyOnly && $isTcgCard) {
        continue;
    }
}
```

### 2. 添加清除缓存功能

在 CardRanking.php 中添加 clearAllCaches 方法：

```php
/**
 * 清除所有缓存文件
 */
public function clearAllCaches() {
    $timeRanges = ['week', 'two_weeks', 'month', 'all'];
    $diyOnlyOptions = [true, false];

    foreach ($timeRanges as $timeRange) {
        foreach ($diyOnlyOptions as $diyOnly) {
            $cacheFile = $this->getCacheFilePath($timeRange, $diyOnly);
            if (file_exists($cacheFile)) {
                unlink($cacheFile);
            }
        }
    }
}
```

在 CardRankingModel.php 中添加 clearAllCaches 方法：

```php
/**
 * 清除所有缓存文件
 */
public function clearAllCaches() {
    return $this->cardRankingCore->clearAllCaches();
}
```

在 CardRankingController.php 中添加 clearCache 方法：

```php
/**
 * 清除所有卡片排行榜缓存
 */
public function clearCache() {
    // 检查功能是否启用
    if (!defined('CARD_RANKING_ENABLED') || !CARD_RANKING_ENABLED) {
        header('Location: ' . BASE_URL);
        exit;
    }

    // 要求管理员权限
    $this->userModel->requirePermission(1);

    // 清除所有缓存
    $this->cardRankingModel->clearAllCaches();

    // 设置成功消息
    $_SESSION['success_message'] = '卡片排行榜缓存已清除';

    // 重定向回卡片排行榜页面
    header('Location: ' . BASE_URL . '?controller=card_ranking');
    exit;
}
```

### 3. 在卡片排行榜页面添加清除缓存按钮

```php
<?php if ($this->userModel->hasPermission(1)): ?>
    <div>
        <a href="<?php echo BASE_URL; ?>?controller=card_ranking&action=update&time_range=<?php echo $timeRange; ?>" class="btn btn-primary">更新排行榜</a>
        <a href="<?php echo BASE_URL; ?>?controller=card_ranking&action=clearCache" class="btn btn-warning ml-2">清除缓存</a>
    </div>
<?php endif; ?>
```

## 效果说明
1. 修复了TCG卡片检测逻辑，确保系统能够正确识别TCG卡片和DIY卡片
2. 添加了清除缓存功能，管理员可以通过点击"清除缓存"按钮清除所有卡片排行榜缓存
3. 在选择"只看DIY卡排名"选项时，系统将正确地只显示DIY卡片，排除所有TCG卡片

## 修改时间
2024年6月24日
