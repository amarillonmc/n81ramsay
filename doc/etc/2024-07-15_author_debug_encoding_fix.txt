# 作者光荣榜调试功能编码修复

## 问题描述

在执行作者光荣榜调试功能时，出现了以下问题：

1. 文件名中包含中文字符时出现"failed to open stream: No such file or directory"错误
2. 生成的文件名和内容出现乱码
3. 由于错误输出导致"headers already sent"错误，无法正常重定向

这些问题主要与文件名中的中文字符和编码相关。在Windows系统中，文件名中的中文字符需要特殊处理，否则会导致文件创建失败。

## 修复内容

### 1. 文件名处理优化

修改了`AuthorController.php`中的`debug`方法，优化了文件名处理逻辑：

- 替换文件名中的非法字符（如`\/:*?"<>|`）
- 对包含非ASCII字符（如中文）的作者名，使用MD5哈希作为文件名前缀，并保留部分原始名称
- 限制文件名长度，避免过长导致的问题

```php
// 生成安全的文件名
// 1. 替换文件名中的非法字符
$safeAuthorName = preg_replace('/[\\\\\/\:\*\?\"\<\>\|]/', '_', $authorName);
// 2. 处理中文和特殊字符，使用MD5哈希确保文件名唯一且安全
if (preg_match('/[^\x20-\x7E]/', $safeAuthorName)) {
    // 如果包含非ASCII字符，使用作者名的MD5哈希作为文件名
    $safeAuthorName = md5($authorName) . '_' . mb_substr($safeAuthorName, 0, 10, 'UTF-8');
}
// 3. 限制文件名长度
if (strlen($safeAuthorName) > 50) {
    $safeAuthorName = substr($safeAuthorName, 0, 50);
}
```

### 2. 文件写入方式改进

改进了文件写入方式，确保正确处理UTF-8编码：

- 使用二进制模式打开文件（`fopen($debugFile, 'wb')`）
- 添加UTF-8 BOM标记（`\xEF\xBB\xBF`）
- 使用`fwrite`写入内容，而不是`file_put_contents`
- 添加错误处理，记录无法创建文件的情况

```php
// 使用二进制模式写入，避免编码问题
$fp = fopen($debugFile, 'wb');
if ($fp) {
    // 添加UTF-8 BOM标记
    fwrite($fp, "\xEF\xBB\xBF");
    fwrite($fp, $content);
    fclose($fp);
    $fileCount++;
} else {
    // 记录错误
    Utils::debug('无法创建调试文件', [
        '文件路径' => $debugFile,
        '作者名' => $authorName,
        '安全文件名' => $safeAuthorName
    ]);
}
```

### 3. 消息处理优化

优化了消息处理方式，避免"headers already sent"错误：

- 使用会话（`$_SESSION['author_debug_message']`）存储消息，而不是URL参数
- 在重定向前清除输出缓冲区
- 修改视图文件，支持显示会话中的消息

```php
// 设置会话消息，避免使用URL参数传递长消息
$_SESSION['author_debug_message'] = "成功生成{$fileCount}个作者调试文件，保存在logs/ranking_{$timestamp}目录下";

// 确保没有输出缓冲区中的内容
if (ob_get_length()) {
    ob_end_clean();
}

// 重定向到作者光荣榜页面
header('Location: ' . BASE_URL . '?controller=author');
```

## 技术说明

1. **文件名编码问题**：Windows系统对文件名有特定的编码要求，特别是对于中文等非ASCII字符。使用MD5哈希可以确保文件名只包含安全的ASCII字符。

2. **UTF-8编码处理**：使用二进制模式写入文件并添加UTF-8 BOM标记，可以确保文件内容正确显示中文字符。

3. **Headers Already Sent错误**：当PHP脚本已经输出内容（如错误信息）后，无法再发送HTTP头信息。通过使用会话存储消息并清除输出缓冲区，可以避免这个问题。
